http:
  middlewares:
    # Strip path prefix so backends see / instead of /wazuh or /portainer
    strip-wazuh-prefix:
      stripPrefix:
        prefixes:
          - "/wazuh"
    strip-portainer-prefix:
      stripPrefix:
        prefixes:
          - "/portainer"
    # Redirect /wazuh and /portainer (no trailing slash) to /wazuh/ and /portainer/
    redirect-wazuh-slash:
      redirectRegex:
        regex: "^https://([^/]+)/wazuh$"
        replacement: "https://${1}/wazuh/"
        permanent: true
    redirect-portainer-slash:
      redirectRegex:
        regex: "^https://([^/]+)/portainer$"
        replacement: "https://${1}/portainer/"
        permanent: true
    redirect-pihole-slash:
      redirectRegex:
        regex: "^https://([^/]+)/pihole$"
        replacement: "https://${1}/pihole/"
        permanent: true
    redirect-app1-slash:
      redirectRegex:
        regex: "^https://([^/]+)/app1$"
        replacement: "https://${1}/app1/"
        permanent: true
    strip-app1-prefix:
      stripPrefix:
        prefixes:
          - "/app1"
    redirect-app2-slash:
      redirectRegex:
        regex: "^https://([^/]+)/app2$"
        replacement: "https://${1}/app2/"
        permanent: true
    strip-app2-prefix:
      stripPrefix:
        prefixes:
          - "/app2"
    strip-new-prefix:
      stripPrefix:
        prefixes:
          - "/new"
    strip-pihole-prefix:
      stripPrefix:
        prefixes:
          - "/pihole"
    strip-traefik-prefix:
      stripPrefix:
        prefixes:
          - "/traefik"
    redirect-grafana-slash:
      redirectRegex:
        regex: "^https://([^/]+)/grafana$"
        replacement: "https://${1}/grafana/"
        permanent: true
    strip-grafana-prefix:
      stripPrefix:
        prefixes:
          - "/grafana"
    redirect-prometheus-slash:
      redirectRegex:
        regex: "^https://([^/]+)/prometheus$"
        replacement: "https://${1}/prometheus/"
        permanent: true
    strip-prometheus-prefix:
      stripPrefix:
        prefixes:
          - "/prometheus"
    # Netbird: ensure backend sees correct scheme/host/port for OAuth redirects (avoids "Unauthenticated")
    netbird-forwarded-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-Host: "netbird.a3jm.com"
          X-Forwarded-Port: "443"
          Forwarded: "proto=https;host=netbird.a3jm.com"
    # Authentik: ensure backend sees correct scheme/host (subdomain authentik.a3jm.com)
    authentik-forwarded-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-Host: "authentik.a3jm.com"
    # Headers for Pi-hole (needs forwarded headers when behind proxy)
    pihole-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-Host: "a3jm.com"
          X-Forwarded-Prefix: "/pihole"
    # Rewrite /login to /admin/login.php for Pi-hole redirects
    replace-path-pihole-login:
      replacePathRegex:
        regex: "^/login$"
        replacement: "/admin/login.php"
    # Add /admin prefix for Pi-hole when accessing /admin directly (rewrite to /admin/index.php)
    add-pihole-admin-prefix:
      replacePathRegex:
        regex: "^/admin$"
        replacement: "/admin/index.php"

  routers:
    # Main site: a3jm.com and www.a3jm.com (priority 50 so path-based routes below take precedence)
    www-default:
      rule: "Host(`a3jm.com`)"
      service: www
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      priority: 50

    www-www:
      rule: "Host(`www.a3jm.com`)"
      service: www
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      priority: 50

    # Pi-hole via subdomain (cleaner than path-based, avoids conflicts)
    pihole-dashboard:
      rule: "Host(`pihole.a3jm.com`)"
      service: pihole
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
    
    # Path-based Pi-hole access - catch Pi-hole API and redirects first (highest priority)
    # Catch Pi-hole API calls (/api/* but exclude our www app's /api/login, /api/register, etc. and Traefik API paths)
    pihole-api:
      rule: "Host(`a3jm.com`) && PathPrefix(`/api`) && !Path(`/api/login`) && !Path(`/api/logout`) && !Path(`/api/register`) && !Path(`/api/register-account`) && !Path(`/api/me`) && !Path(`/api/health`) && !PathPrefix(`/api/admin`) && !PathPrefix(`/api/http`) && !PathPrefix(`/api/rawdata`) && !PathPrefix(`/api/entrypoints`) && !PathPrefix(`/api/version`) && !PathPrefix(`/api/overview`) && !Path(`/api/status`) && !PathPrefix(`/api/tcp`) && !PathPrefix(`/api/udp`)"
      service: pihole
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - pihole-headers
      priority: 300
    
    # Catch Pi-hole static assets
    pihole-assets:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/admin/scripts`) || PathPrefix(`/admin/css`) || PathPrefix(`/admin/js`) || PathPrefix(`/admin/img`) || PathPrefix(`/admin/vendor`))"
      service: pihole
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - pihole-headers
      priority: 300
    
    # Catch Pi-hole admin pages (including /admin exact path, but exclude our www app's /admin/dashboard and /admin/registrations)
    # This must have higher priority than www app's /admin route
    # Note: We catch /admin and rewrite to /admin/index.php for Pi-hole
    pihole-admin-paths:
      rule: "Host(`a3jm.com`) && PathPrefix(`/admin`) && !PathPrefix(`/admin/dashboard`) && !PathPrefix(`/admin/registrations`)"
      service: pihole
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - pihole-headers
        - add-pihole-admin-prefix
      priority: 400
    
    # Catch Pi-hole login.php and index.php (but not our www app's /login)
    pihole-php-files:
      rule: "Host(`a3jm.com`) && (Path(`/login.php`) || Path(`/index.php`))"
      service: pihole
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - pihole-headers
      priority: 300
    
    
    # Main Pi-hole path route
    pihole-via-path:
      rule: "Host(`a3jm.com`) && PathPrefix(`/pihole`)"
      service: pihole
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - pihole-headers
        - strip-pihole-prefix
      priority: 200

    wazuh-via-path:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/wazuh`) || PathPrefix(`/wazuh/`))"
      service: wazuh
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - redirect-wazuh-slash
      priority: 200

    portainer-via-path:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/portainer`) || PathPrefix(`/portainer/`))"
      service: portainer
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - redirect-portainer-slash
        - strip-portainer-prefix
      priority: 200

    # App at a3jm.com/app1 (replaces app.a3jm.com)
    app-via-path:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/app1`) || PathPrefix(`/app1/`))"
      service: app
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - redirect-app1-slash
        - strip-app1-prefix
      priority: 200

    # app2 (app2/ server.js) at a3jm.com/app2, runs in Docker on port 4000
    app2-via-path:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/app2`) || PathPrefix(`/app2/`))"
      service: app2
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - redirect-app2-slash
        - strip-app2-prefix
      priority: 200

    traefik-dashboard:
      rule: "Host(`traefik.a3jm.com`)"
      service: api@internal
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Traefik dashboard via path (a3jm.com/traefik)
    # Catch Traefik-specific API paths that the dashboard calls
    traefik-api-via-path:
      rule: "Host(`a3jm.com`) && PathPrefix(`/traefik/api`)"
      service: api@internal
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - strip-traefik-prefix
      priority: 300

    # Catch Traefik API calls from dashboard (dashboard calls /api/http/*, /api/rawdata, etc.)
    # Exclude www app and Pi-hole API paths
    # Higher priority (350) than Pi-hole (300) to catch Traefik API paths first
    traefik-api-direct:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/api/http`) || PathPrefix(`/api/rawdata`) || PathPrefix(`/api/entrypoints`) || PathPrefix(`/api/version`) || PathPrefix(`/api/overview`) || Path(`/api/status`) || PathPrefix(`/api/tcp`) || PathPrefix(`/api/udp`))"
      service: api@internal
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      priority: 350

    traefik-dashboard-via-path:
      rule: "Host(`a3jm.com`) && PathPrefix(`/traefik/dashboard`)"
      service: api@internal
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - strip-traefik-prefix
      priority: 300

    traefik-via-path:
      rule: "Host(`a3jm.com`) && PathPrefix(`/traefik`)"
      service: api@internal
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - strip-traefik-prefix
      priority: 200

    # Wazuh dashboard (siem/wazuh/wazuh-docker/single-node; wazuh.dashboard on traefik_net)
    wazuh-dashboard:
      rule: "Host(`wazuh.a3jm.com`)"
      service: wazuh
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # Portainer (portainer-server/ → host port 9443)
    portainer-dashboard:
      rule: "Host(`portainer.a3jm.com`)"
      service: portainer
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt

    # app2 backend at a3jm.com/new (same app2 container as /app2)
    app-vm-new:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/new`) || PathPrefix(`/new/`))"
      service: app2
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - strip-new-prefix
      priority: 200

    # Netbird: subdomain netbird.a3jm.com
    netbird-grpc:
      rule: "Host(`netbird.a3jm.com`) && (PathPrefix(`/signalexchange.SignalExchange/`) || PathPrefix(`/management.ManagementService/`))"
      service: netbird-server-h2c
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      priority: 200

    netbird-backend:
      rule: "Host(`netbird.a3jm.com`) && (PathPrefix(`/relay`) || PathPrefix(`/ws-proxy/`) || PathPrefix(`/api`) || PathPrefix(`/oauth2`) || PathPrefix(`/setup`) || PathPrefix(`/setup-keys`))"
      service: netbird-server
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - netbird-forwarded-headers
      priority: 200

    netbird-dashboard:
      rule: "Host(`netbird.a3jm.com`)"
      service: netbird-dashboard
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      priority: 50

    # Grafana – metrics dashboards (path-based: a3jm.com/grafana)
    # No redirect middleware: avoid ERR_TOO_MANY_REDIRECTS (Grafana sends redirects that would loop)
    grafana-via-path:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/grafana`) || PathPrefix(`/grafana/`))"
      service: grafana
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - strip-grafana-prefix
      priority: 200

    # Prometheus – metrics UI (path-based: a3jm.com/prometheus)
    prometheus-via-path:
      rule: "Host(`a3jm.com`) && (PathPrefix(`/prometheus`) || PathPrefix(`/prometheus/`))"
      service: prometheus
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - strip-prometheus-prefix
      priority: 200

    # Authentik – IdP at authentik.a3jm.com
    authentik-dashboard:
      rule: "Host(`authentik.a3jm.com`)"
      service: authentik
      entryPoints:
        - websecure
      tls:
        certResolver: letsencrypt
      middlewares:
        - authentik-forwarded-headers
      priority: 100

  services:
    www:
      loadBalancer:
        servers:
          - url: "http://www:3000"

    app:
      loadBalancer:
        servers:
          - url: "http://app:3000"

    # app2 container (app2/ server.js on port 4000)
    app2:
      loadBalancer:
        servers:
          - url: "http://app2:4000"

    # app2 when run on host (node server.js); use for a3jm.com/new if not using app2 container
    myvm:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:4000"

    # Wazuh dashboard: wazuh.dashboard container on traefik_net (HTTPS on port 5601)
    wazuh:
      loadBalancer:
        servers:
          - url: "https://wazuh.dashboard:5601"
        serversTransport: insecureTransport

    # Portainer: same stack, container port 9443 (HTTPS)
    portainer:
      loadBalancer:
        servers:
          - url: "https://portainer:9443"
        serversTransport: insecureTransport


    # Pi-hole: container on traefik_net, HTTP on port 80
    pihole:
      loadBalancer:
        servers:
          - url: "http://pihole:80"

    # Netbird dashboard (SPA)
    netbird-dashboard:
      loadBalancer:
        servers:
          - url: "http://netbird-dashboard:80"

    # Netbird server HTTP (relay, ws-proxy, api, oauth2)
    netbird-server:
      loadBalancer:
        servers:
          - url: "http://netbird-server:80"

    # Netbird server gRPC (HTTP/2 cleartext)
    netbird-server-h2c:
      loadBalancer:
        servers:
          - url: "h2c://netbird-server:80"
        passHostHeader: true

    # Grafana (port 3000 inside container)
    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    # Prometheus (port 9090)
    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"

    # Authentik server (HTTP 9000)
    authentik:
      loadBalancer:
        servers:
          - url: "http://authentik-server:9000"

  serversTransports:
    insecureTransport:
      insecureSkipVerify: true
